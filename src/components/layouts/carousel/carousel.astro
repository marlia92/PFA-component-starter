---
import clsx from "clsx";
import Button from "../../elements/button/button.astro";
import Component from "../../utils/renderBlock.astro";

const {
  slides,
  autoPlay = false,
  autoScroll = false,
  slideWidthPercent = "100%",
  minSlideWidth = 0,
  style = "",
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => !key.startsWith("_"))
);

const dataAttributes: Record<string, string> = {};

// These are hardcoded variables that could be configured to be set
// by the editor.

// Shows the indicators dots.
dataAttributes["data-show-indicators"] = "true";

// Shows the navigational arrows.
dataAttributes["data-show-arrows"] = "true";

// If false, the carousel will stop at the last slide.
dataAttributes["data-loop"] = "true";

// Positions the slides in the viewport.
dataAttributes["data-align"] = "center";

// Allows the carousel to scroll a specific number of
// slides at a time.
dataAttributes["data-slides-to-scroll"] = "auto";

if (autoPlay) {
  dataAttributes["data-autoplay"] = "3";
}

if (autoScroll) {
  dataAttributes["data-autoscroll"] = "1";
  dataAttributes["data-show-indicators"] = "false";
  dataAttributes["data-show-arrows"] = "false";
}

const carouselClasses = clsx("carousel");

// Build the style attribute, merging custom styles with CSS variables
const carouselStyles = `
  --slide-width: ${slideWidthPercent};
  --min-slide-width: ${minSlideWidth}px;
  ${style}
`.trim();
---

<section
  class:list={carouselClasses}
  role="region"
  aria-label="Carousel"
  style={carouselStyles}
  {...htmlAttributes}
  {...dataAttributes}
>
  <div class="viewport">
    <div class="track">
      {
        slides.map((slide: any, index: number) => (
          <div class="slide" role="group" aria-label={`Slide ${index + 1} of ${slides.length}`}>
            <Component contentBlocks={slide.content_blocks} />
          </div>
        ))
      }
    </div>
  </div>

  <div class="controls">
    <Button
      iconName="arrow-left"
      size="lg"
      variant="tertiary"
      hideText={true}
      aria-label="Previous slide"
      class="prev"
    />

    <Button
      iconName="arrow-right"
      size="lg"
      variant="tertiary"
      hideText={true}
      aria-label="Next slide"
      class="next"
    />
  </div>

  <div class="indicators"></div>
</section>

<style>
  .carousel {
    position: relative;
    width: 100%;
    --slide-width: 100%;
    --min-slide-width: 0px;

    > .viewport {
      overflow: hidden;
      position: relative;
      width: 100%;
    }

    > .viewport > .track {
      display: flex;
      flex-wrap: nowrap;
    }

    > .viewport > .track > .slide {
      flex-shrink: 0;
      flex-basis: calc(max(var(--slide-width), var(--min-slide-width)));
    }

    > .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: absolute;
      top: 50%;
      left: var(--spacing-md);
      right: var(--spacing-md);
      transform: translateY(-50%);
      z-index: 10;
      pointer-events: none;
    }

    > .controls > .prev,
    > .controls > .next {
      pointer-events: auto;
      border-radius: var(--radius-full);
      background-color: var(--color-bg);

      &:hover {
        background-color: var(--color-bg-surface);
      }
    }

    > .indicators {
      display: flex;
      justify-content: center;
      margin-top: var(--spacing-sm);
    }

    > .indicators > :global(.indicator) {
      border-radius: var(--radius-full);
      width: 8px;
      height: 8px;
      margin: 0 var(--spacing-xs);
      transition:
        transform var(--animation-normal) ease,
        background-color var(--animation-normal) ease;
      border: none;
      cursor: pointer;

      &[data-selected="true"] {
        background-color: var(--color-brand-muted);
        transform: scale(1.2);
      }
    }

    &[data-show-indicators="false"] {
      > .indicators {
        display: none;
      }
    }

    &[data-show-arrows="false"] {
      > .controls {
        display: none;
      }
    }
  }
</style>

<script>
  import EmblaCarousel from "embla-carousel";
  import AutoScroll from "embla-carousel-auto-scroll";
  import Autoplay from "embla-carousel-autoplay";

  export default function setupCarousels() {
    const carousels = document.querySelectorAll(".carousel");

    carousels.forEach((carousel) => {
      // Check if this carousel has already been initialized
      if (carousel.hasAttribute("data-embla-initialized")) {
        return;
      }

      const viewport = carousel.querySelector(".viewport") as HTMLElement;
      const track = carousel.querySelector(".track") as HTMLElement;

      if (!viewport || !track) return;

      const loop = carousel.hasAttribute("data-loop");
      const slidesToScroll = carousel.hasAttribute("data-slides-to-scroll")
        ? Number(carousel.getAttribute("data-slides-to-scroll")) || "auto"
        : "auto";
      const align = (carousel.getAttribute("data-align") || "start") as "start" | "center" | "end";

      const plugins = [];
      if (carousel.hasAttribute("data-autoplay")) {
        const autoplayInterval = Number(carousel.getAttribute("data-autoplay")) * 1000 || 3000;
        plugins.push(Autoplay({ delay: autoplayInterval, stopOnInteraction: false }));
      }

      let watchDrag = true;
      if (carousel.hasAttribute("data-autoscroll")) {
        const scrollValue = parseFloat(carousel.getAttribute("data-autoscroll") || "1");
        const speed = isNaN(scrollValue) ? 1 : scrollValue;
        plugins.push(AutoScroll({ speed }));
        watchDrag = false;
      }

      const embla = EmblaCarousel(
        viewport,
        {
          loop,
          slidesToScroll,
          align,
          watchDrag,
          duration: 20, // Faster scroll duration
          startIndex: 0,
          skipSnaps: false,
          inViewThreshold: 0.7,
        },
        plugins
      );

      // Mark this carousel as initialized
      carousel.setAttribute("data-embla-initialized", "true");

      // Navigation
      const prevButton = carousel.querySelector(".prev") as HTMLButtonElement;
      const nextButton = carousel.querySelector(".next") as HTMLButtonElement;

      const updateButtons = () => {
        if (prevButton) prevButton.disabled = !embla.canScrollPrev();
        if (nextButton) nextButton.disabled = !embla.canScrollNext();
      };

      updateButtons();
      embla.on("select", updateButtons);
      if (prevButton) prevButton.addEventListener("click", () => embla.scrollPrev());
      if (nextButton) nextButton.addEventListener("click", () => embla.scrollNext());

      // Indicators
      const indicatorsContainer = carousel.querySelector(".indicators") as HTMLElement;

      let renderDots = () => {};
      let updateSelectedDot = () => {};

      if (indicatorsContainer) {
        renderDots = () => {
          indicatorsContainer.innerHTML = "";

          embla.scrollSnapList().forEach((_, index) => {
            const dot = document.createElement("button");
            dot.className = "indicator";
            dot.setAttribute("type", "button");
            dot.setAttribute("aria-label", `Go to slide ${index + 1}`);
            dot.setAttribute("data-selected", (index === embla.selectedScrollSnap()).toString());
            dot.setAttribute("aria-selected", (index === embla.selectedScrollSnap()).toString());
            dot.addEventListener("click", () => embla.scrollTo(index));
            indicatorsContainer.appendChild(dot);
          });
        };

        updateSelectedDot = () => {
          const dots = indicatorsContainer.querySelectorAll(".indicator");
          dots.forEach((dot, index) => {
            const isSelected = index === embla.selectedScrollSnap();
            dot.setAttribute("data-selected", isSelected.toString());
            dot.setAttribute("aria-selected", isSelected.toString());
          });
        };

        embla.on("select", updateSelectedDot);
        renderDots();
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupCarousels);
  } else {
    setupCarousels();
  }
</script>
